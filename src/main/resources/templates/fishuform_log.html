<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no, email=no, date=no, address=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="format-detection" content="telephone=no"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <link href="/css/bksystem.css" rel="stylesheet" type="text/css"/>
    <link href="/font/iconfont.css" rel="stylesheet" type="text/css"/>
    <link href="/css/module.css" rel="stylesheet" type="text/css"/>
    <link href="/css/pages.css" rel="stylesheet" type="text/css"/>
    <title>商品管理</title>
    <script src="/js/jquery-1.9.1.min.js" type="text/javascript"></script>
    <script src="/js/jquery.nicescroll.js" type="text/javascript"></script>
    <script src="/js/HUpages.js" type="text/javascript"></script>
    <script src="/js/common.js" type="text/javascript"></script>
    <script src="/js/jquery.table2excel.js" type="text/javascript"></script>

</head>

<body id="situation">
<div class="pages-style">
    <!--左侧菜单栏-->
    <!--<div class="bk-con-menu " id="bk-con-menu">-->
        <!--<div class="menubtn">-->
            <!--<span class="close_btn samebtn"><i>隐藏</i></span>-->
            <!--<span class="show_btn samebtn"><i>显示</i></span>-->
        <!--</div>-->
        <!--<div class="title-menu">栏目分类-->

        <!--&lt;!&ndash;            <div style="color:#FF00FF">店铺名称格式: FRUD-US</div>&ndash;&gt;-->

        <!--&lt;!&ndash;            <input type="text" name="inv_no" id="shopid" style="text-align:center" placeholder="店铺名称"/></li>&ndash;&gt;-->
        <!--<div style="color:#FF00FF">时间格式: 2021-01-02 13:15:20</div>-->
        <!--<input type="text" name="inv_no" id="starttime" style="text-align:center" placeholder="开始时间"/></li>-->
        <!--<input type="text" name="inv_no" id="endtime" style="text-align:center" placeholder="结束时间"/></li>-->
        <!--<button class="btn button_btn bg-deep-blue" type="button" onclick="findwlnReturnOrder()"><i-->
        <!--class="iconfont"></i>&nbsp;查找管易出库单-->
        <!--</button>-->
        <!--<button class="btn button_btn btn-danger" type="button" onclick="addwlnReturnOrder()"><i-->
        <!--class="iconfont"></i>&nbsp;下载至中间表-->
        <!--</button>-->
        <!--</div>-->
        <!--<div class="breadcrumb" id="breadcrumb">-->
            <!--<ul class="clearfix menu-section menulist" id="menu-section">-->

            <!--</ul>-->
        <!--</div>-->
        <!--右侧内容-->
        <div class="bk-con-message message-section" id="iframe_box">
            <!--编辑内容-->
            <div class="operation  mb15">
                <button class="btn button_btn btn-green" type="button" onclick="findsal()"><i class="iconfont"></i>&nbsp;
                    查询所有日志
                </button>
                <!--<button class="btn button_btn btn-danger" type="button" onclick="findsalNotLoad()"><i-->
                        <!--class="iconfont"></i>&nbsp;-->
                    <!--查询上传失败飞书报销流程-->
                <!--</button>-->
                <!--<button class="btn button_btn bg-deep-blue" type="button" id="salloadall" onclick="salload()">-->
                    <!--<i class="iconfont"></i>&nbsp;-->
                    <!--重新上传-->
                <!--</button>-->
                <!--<button class="btn button_btn btn-danger" type="button" id="notload" onclick="notload()">-->
                    <!--<i class="iconfont"></i>取消对接-->
                <!--</button>-->
                <!--<button class="btn button_btn bg-deep-gray" type="button" onclick="DisplayMyTableEntry()"><i-->
                        <!--class="iconfont"></i>&nbsp;返回主表-->
                <!--</button>-->
                <button class="btn button_btn btn-green" type="button" onclick="table2excel()"><i
                        class="iconfont"></i>下载表格
                </button>

            </div>
            <div id="warning">正在处理，请稍等..........</div>
            <!--列表内容-->
            <div class="page_content clearfix mb15 table-module "  style="width:100%; height:80%;overflow:scroll">
                <!--<div style="width:100%; height:80%; overflow-y:scroll; overflow-x:scroll;">-->
                <table class="gallery table table_list table_striped table-bordered table-layout:fixed" id="sal">
                    <!--<table border="1" rules="all" style="width:2000px; height:100px; text-align:center">-->

                    <thead>
                    <tr>
                        <th>编号</th>
                        <th><label><input type="checkbox" class="ace" id="selectAll" name="selectAll"><span
                                class="lbl"></span></label></th>
                        <th>日志发生时间</th>
                        <th>错误日志消息</th>

                        <th>飞书code</th>
                        <!--                        <th>币种</th>-->
                        <th>飞书事件类型</th>
                        <th>飞书事件类型名称</th>
                        <th>日志详细消息</th>





                    </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
                <!--</div>-->

                <table class="gallery table table_list table_striped table-bordered" width="50%" style="table-layout:fixed;word-break:break-all;background:#f2f2f2"id="salentry">
                    <thead>
                    <tr>
                        <th>子单编号</th>
                        <th>instanceCode</th>
                        <th>费用类型</th>
                        <th>金蝶费用类型编码</th>
                        <th>发票类型</th>
                        <th>金蝶发票类型编码</th>
                        <th>付款金额</th>

                    </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>


            </div>
        </div>
    </div>
<!--</div>-->
</body>
</html>

<script>
    $(function () {
        //内页框架结构编辑
        $("#situation").Hupage({
            slide: '#breadcrumb',
            padding: 15,
            menuModule: '#bk-con-menu', //菜单模块
            pagecontent: '.page_content',//自定义属性
            operation: '.operation',//自定义属性
            scrollbar: function (e) {
                e.niceScroll({
                    cursorcolor: "#dddddd",
                    cursoropacitymax: 1,
                    touchbehavior: false,
                    cursorwidth: "3px",
                    cursorborder: "0",
                    cursorborderradius: "3px",
                });
            },
            expand: function (thisBox, settings) {
                var pc = "";
                $(settings.pagecontent).css("margin-bottom") != null ? pc = parseInt($(settings.pagecontent).css("margin-bottom").replace("px", "")) : '';
                $(settings.pagecontent).css({height: $(window).height() - $(settings.operation).outerHeight() - pc - (settings.padding * 2)})
                settings.scrollbar($(settings.slide) && $(settings.pagecontent));
            }//自定义方法
        });
    });

    var getjson = "";
    var getEntryjson = "";

    //查询所有的飞书单据
    function findsal() {
        if(isClick) {
//定时器
            isClick = false;
            setTimeout(function() {
                isClick = true;
            }, 3000);//3秒内不能重复点击
        }else{
            alert("请不要短时间内重复点击按钮")
            return;
        }
        $.ajax({
            url: "logmsgform/logDESC",
            type: "get",
            dataType: "json",
            success: function (data) {
                /*这个方法里是ajax发送请求成功之后执行的代码*/
                showData(data);//我们仅做数据展示
                getjson = data;
            },
            error: function (msg) {
                alert("ajax连接异常：" + msg);
            }
        });
    };


    function findsalentyr() {
//         if(isClick) {
// //定时器
//             isClick = false;
//             setTimeout(function() {
//                 isClick = true;
//             }, 3000);//3秒内不能重复点击
//         }else{
//             alert("请不要短时间内重复点击按钮")
//             return;
//         }
        $.ajax({
            url: "fishuformentry",
            type: "get",
            dataType: "json",
            success: function (data) {
                /*这个方法里是ajax发送请求成功之后执行的代码*/
                //showData(data);//我们仅做数据展示
                getEntryjson = data;
            },
            error: function (msg) {
                alert("ajax连接异常：" + msg);
            }
        });
    };


    //查询未上传的
    function findsalNotLoad() {
        if(isClick) {
//定时器
            isClick = false;
            setTimeout(function() {
                isClick = true;
            }, 3000);//3秒内不能重复点击
        }else{
            alert("请不要短时间内重复点击按钮")
            return;
        }
        $.ajax({
            url: "saleNotLoad",
            type: "post",
            dataType: "json",
            success: function (data) {
                /*这个方法里是ajax发送请求成功之后执行的代码*/
                showData(data);//我们仅做数据展示
                getjson = data;
            },
            error: function (msg) {
                alert("ajax连接异常：" + msg);
            }
        });
    };


    //展示数据

    function showData(data) {
        //删除除了第一行的内容
        $("#sal  tr:not(:first)").html("");
        var str = "";//定义用于拼接的字符串
        var number = 1;



        for (var i = 0; i < data.data.length; i++) {
//             var date1=data[i].shipment_date;
//             var date2=date1.substring(0,19);
//             // var date=(new Date(parseFloat(date1.time))).format("yyyy-MM-dd");
//             var date = date2.replace('T', ' ');
//             if(data[i].sidname=="Frap-DE"){
//                 date = date.replace(/-/g,'/');
//                 var timestamp = new Date(date).getTime();
// // 根据毫秒数构建 Date 对象
//                 var datesss = new Date(timestamp);
// // 格式化日期
//
//                 datesss=datesss.setHours(datesss.getHours()+1)//小时
//                 date=(new Date(parseFloat(datesss))).format("yyyy-MM-dd hh:mm:ss");
//             }

            //拼接表格的行和列

                str = "<tr>\n" +
                    "</td><td onclick=\"DisplayMyTable()\" >" + number +
                    "</td><td><label><input type=\"checkbox\" class=\"ace\" name=\"chooseInfo\"  " +
                    "value=" + data.data[i].id + "><span class=\"lbl\"></span></label>" +
                    "</td><td>" + data.data[i].logdatetime +
                    "</td><td>" + data.data[i].loginfomsg +

                    "</td><td>" + data.data[i].feishuInstanscode +
                    "</td><td>" + data.data[i].approvecode +
                    "</td><td>" + data.data[i].approvecodename +
                    "</td><td>" + data.data[i].xiangxidelog +
                    "</td></tr>";
                //追加到table中
                $("#sal").append(str);






            number++;
        }
    };
    //转换时间参数
    Date.prototype.format = function (format) {
        var o = {
            "M+": this.getMonth() + 1,// month
            "d+": this.getDate(),// day
            "h+": this.getHours(),// hour
            "m+": this.getMinutes(),// minute
            "s+": this.getSeconds(),// second
            "q+": Math.floor((this.getMonth() + 3) / 3),// quarter
            "S": this.getMilliseconds()
            // millisecond
        };
        if (/(y+)/.test(format) || /(Y+)/.test(format)) {
            format = format.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        }
        for (var k in o) {
            if (new RegExp("(" + k + ")").test(format)) {
                format = format.replace(RegExp.$1, RegExp.$1.length == 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length));
            }
        }
        return format;
    };

    //打开页面直接运行此方法
    DisplayMyTable1();
    loadingclose();

    //明细单切换
    function DisplayMyTable() {
        //删除除了第一行的内容
        $("#salentry  tr:not(:first)").html("");
        var str = "";//定义用于拼接的字符串
        var number = 1;
        //关闭主单div，显示明细单div
        document.getElementById("sal").style.display="none";
        document.getElementById("salentry").style.display="block";

        if (event.srcElement.tagName == "TD") {
            curRow = event.srcElement.parentElement;
            //定位到主单的行
            tr = curRow.innerHTML;
            var td = curRow.cells;
            //  定位到主单的编号
            var td_host = td[3].innerHTML;
            alert(td_host);
            findsalentyr();
            //  获取明细数据
            //   $.ajax(
            //       {
            //           data: {'instancecode': td_host},
            //           dataType: 'json',
            //           success: function () {
            //               alert("重传结束")
            //               loadingclose();
            //               findsal();
            //               document.getElementById("salloadall").disabled=false;
            //           },
            //           type: 'post',
            //           url: 'saleload',
            //           traditional: true,
            //           async: true, //同步请求(false)，默认情况下是异步（true）
            //           beforeSend: function () {
            //               document.getElementById("salloadall").disabled=true;
            //               loadingopen();
            //           }
            //       }
            //   );


            //根据编号得到主单的明细单
            var entryValue=getEntryjson.data.records;
            alert(entryValue);




            for (var i = 0; i < entryValue.length; i++) {
                //拼接表格的行和列
                if(getEntryjson.data.records[i].instanceCode==td_host){

                    str = "<tr>\n" +
                        "<td>" + number +
                        "<td>" + entryValue[i].instanceCode +
                        "</td><td>" + entryValue[i].monytype +
                        "</td><td>" + entryValue[i].monyTypeNumber+
                        "</td><td>" + entryValue[i].fapiao +
                        "</td><td>" + entryValue[i].fapiaoNumber +
                        "</td><td>" + entryValue[i].money +
                        "</td></tr>";
                }else{

                    continue;

                }


                //追加到table中
                $("#salentry").append(str);
                number++;
            }
        }


    }




    //主表，明细表 显示与关闭
    function DisplayMyTableEntry() {
        document.getElementById("salentry").style.display = "none";
        document.getElementById("sal").style.display = "block";
    }

    function DisplayMyTable1() {
        document.getElementById("salentry").style.display = "none";
        document.getElementById("sal").style.display = "block";
    }

    //复选框全选，全不选
    $('input[name="selectAll"]').on("click", function () {
        if ($(this).is(':checked')) {
            $('input[name="chooseInfo"]').each(function () {
                $(this).prop("checked", true);
            });
        } else {
            $('input[name="chooseInfo"]').each(function () {
                $(this).prop("checked", false);
            });
        }
    });

    //提交复选框内容
    function salload() {

        if(isClick) {
//定时器
            isClick = false;
            setTimeout(function() {
                isClick = true;
            }, 3000);//3秒内不能重复点击
        }else{
            alert("请不要短时间内重复点击按钮")
            return;
        }
        var salID = [];
        $("input[name='chooseInfo']:checked").each(function (i) {
            salID[i] = $(this).val();

            if (salID[i] == "" || salID[i] == "null" || salID[i] == null) {
                alert("出现未知错误");
                return;
            }
        });
        if (salID.length == 0) {
            alert("未选中数据");
            return;
        };
        if(salID.length>5000){
            salID=salID.slice(0,5000)
            alert("数据过大，自动选取前5000条");
        };

        $.ajax(
            {
                data: {'salID': salID},
                dataType: 'text',
                success: function () {
                    alert("重传结束")
                    loadingclose();
                    findsal();
                    document.getElementById("salloadall").disabled=false;
                },
                type: 'post',
                url: 'saleload',
                traditional: true,
                async: true, //同步请求(false)，默认情况下是异步（true）
                beforeSend: function () {
                    document.getElementById("salloadall").disabled=true;
                    loadingopen();
                }
            }
        );

    }

    function loadingclose() {
        document.getElementById("warning").style.display = "none";
    }

    function loadingopen() {
        document.getElementById("warning").style.display = "block";
    }

    function findwlnReturnOrder() {
        if(isClick) {
//定时器
            isClick = false;
            setTimeout(function() {
                isClick = true;
            }, 1000);//3秒内不能重复点击
        }else{
            alert("请不要短时间内重复点击按钮")
            return;
        }
        // var shopid= $("#shopid").val();
        var starttime = $("#starttime").val();
        var endtime = $("#endtime").val();
        var numReg = /^((\d{2}(([02468][048])|([13579][26]))[\-\/\s]?((((0?[13578])|(1[02]))[\-\/\s]?((0?[1-9])|([1-2][0-9])|(3[01])))|(((0?[469])|(11))[\-\/\s]?((0?[1-9])|([1-2][0-9])|(30)))|(0?2[\-\/\s]?((0?[1-9])|([1-2][0-9])))))|(\d{2}(([02468][1235679])|([13579][01345789]))[\-\/\s]?((((0?[13578])|(1[02]))[\-\/\s]?((0?[1-9])|([1-2][0-9])|(3[01])))|(((0?[469])|(11))[\-\/\s]?((0?[1-9])|([1-2][0-9])|(30)))|(0?2[\-\/\s]?((0?[1-9])|(1[0-9])|(2[0-8]))))))(\s((([0-1][0-9])|(2?[0-3]))\:([0-5]?[0-9])((\s)|(\:([0-5]?[0-9])))))?$/

        //    var numReg = /^((?:19|20)\d\d)\-((0?[1-9])|(1[0-2]))\-((0?[1-9])|([1-2][0-9])|30|31)$/;
        var numRe = new RegExp(numReg)
        if (!numRe.test(starttime)) {
            alert("请输入正确的时间格式");
            return;
        }
        if (!numRe.test(endtime)) {
            alert("请输入正确的时间格式");
            return;
        }
        // if(shopid==null||shopid==""){
        //     alert("请输入店铺名称");
        //     return;
        // }

        $.ajax(
            {
                data: {
                    'starttime': starttime,
                    'endtime': endtime
                },
                dataType: 'json',
                success: function (data) {
                    loadingclose();
                    //如果某字段存在
                    if (data.hasOwnProperty("message")) {
                        alert(data.message + data.error_details);
                        return;
                    }
                    showData(data);
                    getjson = data;
                    addjson = data;
                },
                type: 'post',
                url: 'findGYsaleOrder',
                error: function (msg) {
                    alert("ajax连接异常：" + msg);
                    loadingclose();
                },
                async: true, //同步请求(false)，默认情况下是异步（true）
                beforeSend: function () {
                    loadingopen();
                }
            }
        );
    }

    function addwlnReturnOrder() {
        if(isClick) {
//定时器
            isClick = false;
            setTimeout(function() {
                isClick = true;
            }, 3000);//3秒内不能重复点击
        }else{
            alert("请不要短时间内多次点击")
            return;
        }
        // var adds=  JSON.stringify(addjson);
        $.ajax(
            {
                // data: {'addjson': adds},
                // dataType: 'text',
                success: function (data) {
                    loadingclose();
                    alert(data);
                },
                type: 'post',
                url: 'addSaleOrder',
                error: function (msg) {
                    alert("ajax连接异常：" + msg);
                    loadingclose();
                },
                async: true, //同步请求(false)，默认情况下是异步（true）
                beforeSend: function () {
                    loadingopen();
                }
            }
        );
    }


    var isClick = true;

    function table2excel(){
        $("#sal").table2excel({
            // 不被导出的表格行的class类
            exclude: ".ace",
            // 导出的Excel文档的名称
            name: "飞书",
            // Excel文件的名称
            filename: "飞书"+new Date().getTime(),
            //文件后缀名
            fileext: ".xls",
            //是否导出图片
            exclude_img: false,
            //是否导出超链接
            exclude_links: false,
            //是否导出输入框中的内容
            exclude_inputs: false
        });
    }




</script>
